openapi: 3.0.3

info:
  title: Walkie REST API
  description: |
    Official REST API documentation for Walkie Backend.
    
    **Architecture:**
    - Authentication handled via Supabase Auth
    - Business logic implemented via PostgreSQL RPCs
    - Row Level Security (RLS) enforced at database level
    - Frontend never sends user_id (resolved from auth.uid())
  
    
    **Current Version:** 2.1.0 (includes User Themes: color_theme + ui_mode)
  version: 2.1.0


servers:
  - url: https://ftafbdjzritdvsibpqtp.supabase.co
    description: Production

tags:
  - name: Auth
    description: Authentication & user identity (Supabase)
  - name: Projects
    description: Project management & membership
  - name: Project Members
    description: Add/remove/update project members
  - name: Conversations
    description: Conversations & memberships
  - name: Messages
    description: Messages, reactions, edits & mentions
  - name: TODO Lists
    description: TODO list management
  - name: TODO Items
    description: TODO item management
  - name: Follow-ups
    description: Message follow-up tracking
  - name: Notifications
    description: User notifications & read status
  - name: Direct Access
    description: Direct table access (RLS-protected)

# ==========================
# SECURITY
# ==========================
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: apikey
      description: Supabase anon key (public)

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT token (from /auth/v1/token)

  # ==========================
  # REUSABLE SCHEMAS
  # ==========================
  schemas:
    UUID:
      type: string
      format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"

    Timestamp:
      type: string
      format: date-time
      example: "2026-02-02T14:30:00Z"

    Date:
      type: string
      format: date
      example: "2026-02-10"

    Error:
      type: object
      properties:
        message:
          type: string
        code:
          type: string
        hint:
          type: string

# ==========================
# PATHS
# ==========================
paths:

  # ======================================================
  # AUTH ‚Äî EMAIL / PASSWORD
  # ======================================================
  /auth/v1/token:
    post:
      tags: [Auth]
      summary: Login or Sign Up with email and password
      description: |
        Supabase Auth endpoint.
        
        - `grant_type=password` ‚Üí Login
        - `grant_type=signup` ‚Üí Create account (not standard, use /signup)
      security:
        - ApiKeyAuth: []
      parameters:
        - in: query
          name: grant_type
          required: true
          schema:
            type: string
            enum: [password]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: alice@walker.dev
                password:
                  type: string
                  format: password
                  example: strongpassword123
      responses:
        '200':
          description: Authenticated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  expires_in:
                    type: integer
                  token_type:
                    type: string
                    example: bearer
                  user:
                    type: object
        '400':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/v1/signup:
    post:
      tags: [Auth]
      summary: Sign up new user
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                  minLength: 8
      responses:
        '200':
          description: User created
        '400':
          description: Invalid input

  # ======================================================
  # AUTH ‚Äî OAUTH (GOOGLE / APPLE)
  # ======================================================
  /auth/v1/authorize:
    get:
      tags: [Auth]
      summary: OAuth login (Google / Apple)
      description: |
        Redirect-based OAuth flow.
        
        Supported providers:
        - Google Sign In
        - Apple Sign In
      parameters:
        - in: query
          name: provider
          required: true
          schema:
            type: string
            enum: [google, apple]
        - in: query
          name: redirect_to
          required: false
          schema:
            type: string
            example: https://app.walker.dev/auth/callback
      responses:
        '302':
          description: Redirect to OAuth provider

  # ======================================================
  # PROJECTS
  # ======================================================
  /rest/v1/rpc/rpc__project_create:
    post:
      tags: [Projects]
      summary: Create project
      description: |
        Creates a new project. Authenticated user becomes owner.
        
        **Permissions:** Any authenticated user
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_name, p_description]
              properties:
                p_name:
                  type: string
                  example: "Q1 2026 Launch"
                p_description:
                  type: string
                  example: "Planning for Q1 product launch"
      responses:
        '200':
          description: Project created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UUID'

  /rest/v1/rpc/rpc__project_list_for_user:
    post:
      tags: [Projects]
      summary: List projects for authenticated user
      description: |
        Returns all projects where user is a member.
        
        **Permissions:** Authenticated user
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: Projects list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    project_id:
                      $ref: '#/components/schemas/UUID'
                    name:
                      type: string
                    description:
                      type: string
                    archived:
                      type: boolean
                    role:
                      type: string
                      enum: [owner, admin, member]
                    unread_messages_count:
                      type: integer
                    last_activity_at:
                      $ref: '#/components/schemas/Timestamp'

  /rest/v1/rpc/rpc__project_archive:
    post:
      tags: [Projects]
      summary: Archive or unarchive project
      description: |
        Sets the archived flag on a project.
        
        **Permissions:** Project owner or admin
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id, p_archived]
              properties:
                p_project_id:
                  $ref: '#/components/schemas/UUID'
                p_archived:
                  type: boolean
      responses:
        '200':
          description: Project updated

  # ======================================================
  # PROJECT MEMBERS
  # ======================================================
  /rest/v1/rpc/rpc__project_member_add:
    post:
      tags: [Project Members]
      summary: Add member to project
      description: |
        Adds a user to a project by email.
        
        **Permissions:** Project owner or admin
        
        **Roles:** owner, admin, member
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id, p_user_email]
              properties:
                p_project_id:
                  $ref: '#/components/schemas/UUID'
                p_user_email:
                  type: string
                  format: email
                  example: "bob@example.com"
                p_role:
                  type: string
                  enum: [owner, admin, member]
                  default: member
      responses:
        '200':
          description: Member added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  project_id:
                    $ref: '#/components/schemas/UUID'
                  user_id:
                    $ref: '#/components/schemas/UUID'
                  role:
                    type: string
                  joined_at:
                    $ref: '#/components/schemas/Timestamp'
        '400':
          description: User not found or already a member
        '403':
          description: Permission denied

  /rest/v1/rpc/rpc__project_member_remove:
    post:
      tags: [Project Members]
      summary: Remove member from project
      description: |
        Removes a user from a project.
        
        **Permissions:** 
        - Project owner (can remove anyone)
        - Any member (can remove themselves)
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id, p_user_id]
              properties:
                p_project_id:
                  $ref: '#/components/schemas/UUID'
                p_user_id:
                  $ref: '#/components/schemas/UUID'
      responses:
        '204':
          description: Member removed
        '403':
          description: Permission denied
        '404':
          description: User not a project member

  /rest/v1/rpc/rpc__project_member_update_role:
    post:
      tags: [Project Members]
      summary: Update member role
      description: |
        Changes a project member's role.
        
        **Permissions:** Project owner only
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id, p_user_id, p_new_role]
              properties:
                p_project_id:
                  $ref: '#/components/schemas/UUID'
                p_user_id:
                  $ref: '#/components/schemas/UUID'
                p_new_role:
                  type: string
                  enum: [owner, admin, member]
      responses:
        '200':
          description: Role updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  project_id:
                    $ref: '#/components/schemas/UUID'
                  user_id:
                    $ref: '#/components/schemas/UUID'
                  role:
                    type: string

  # ======================================================
  # CONVERSATIONS
  # ======================================================
  /rest/v1/rpc/rpc__conversation_create:
    post:
      tags: [Conversations]
      summary: Create conversation
      description: |
        Creates a new conversation with complete bootstrap:
        - Conversation record
        - Creator as member
        - Creator as owner role
        - Initial read state
        
        **Permissions:** Project member
        
        **Note:** Only one active conversation per project
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                p_project_id:
                  $ref: '#/components/schemas/UUID'
                p_title:
                  type: string
                  example: "General Discussion"
                  nullable: true
                p_type:
                  type: string
                  enum: [project, direct]
                  default: project
            examples:
              project_conversation:
                summary: Project conversation
                value:
                  p_project_id: "550e8400-e29b-41d4-a716-446655440000"
                  p_title: "General Discussion"
                  p_type: "project"
      responses:
        '200':
          description: Conversation created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    $ref: '#/components/schemas/UUID'
                  project_id:
                    $ref: '#/components/schemas/UUID'
                  title:
                    type: string
                  type:
                    type: string
                  created_by:
                    $ref: '#/components/schemas/UUID'
                  created_at:
                    $ref: '#/components/schemas/Timestamp'
                  last_message_at:
                    $ref: '#/components/schemas/Timestamp'
                    nullable: true
                  member_count:
                    type: integer
                  user_role:
                    type: string
        '400':
          description: Project already has active conversation
        '403':
          description: Not a project member

  /rest/v1/rpc/rpc__conversation_list_for_user:
    post:
      tags: [Conversations]
      summary: List conversations for user
      description: |
        Returns all conversations where user is a member.
        Includes unread count per conversation.
        
        **Permissions:** Authenticated user
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: Conversations list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    conversation_id:
                      $ref: '#/components/schemas/UUID'
                    title:
                      type: string
                    type:
                      type: string
                    last_message_at:
                      $ref: '#/components/schemas/Timestamp'
                    unread_count:
                      type: integer

  /rest/v1/rpc/rpc__conversation_mark_read:
    post:
      tags: [Conversations]
      summary: Mark conversation as read
      description: |
        Updates last read message for authenticated user.
        
        **Permissions:** Conversation member
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_conversation_id, p_message_id]
              properties:
                p_conversation_id:
                  $ref: '#/components/schemas/UUID'
                p_message_id:
                  $ref: '#/components/schemas/UUID'
      responses:
        '204':
          description: Read state updated

  # ======================================================
  # MESSAGES
  # ======================================================
  /rest/v1/rpc/rpc__message_send:
    post:
      tags: [Messages]
      summary: Send message
      description: |
        Creates a new message in a conversation.
        Sender automatically set from auth.uid().
        
        **Permissions:** Conversation member with write access
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_conversation_id, p_content]
              properties:
                p_conversation_id:
                  $ref: '#/components/schemas/UUID'
                p_content:
                  type: string
                  example: "Hello team!"
                p_message_type:
                  type: string
                  enum: [text, system, file]
                  default: text
      responses:
        '200':
          description: Message created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UUID'

  /rest/v1/rpc/rpc__message_edit:
    post:
      tags: [Messages]
      summary: Edit message
      description: |
        Edits message content and logs edit history.
        
        **Permissions:** Message sender only
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_message_id, p_new_content]
              properties:
                p_message_id:
                  $ref: '#/components/schemas/UUID'
                p_new_content:
                  type: string
                  example: "Updated message content"
      responses:
        '200':
          description: Message updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    $ref: '#/components/schemas/UUID'
                  conversation_id:
                    $ref: '#/components/schemas/UUID'
                  sender_id:
                    $ref: '#/components/schemas/UUID'
                  content:
                    type: string
                  message_type:
                    type: string
                  edited:
                    type: boolean
                  created_at:
                    $ref: '#/components/schemas/Timestamp'
                  updated_at:
                    $ref: '#/components/schemas/Timestamp'
        '403':
          description: Only sender can edit

  /rest/v1/rpc/rpc__message_delete:
    post:
      tags: [Messages]
      summary: Delete message (soft delete)
      description: |
        Soft deletes a message.
        
        **Permissions:** Message sender OR conversation admin/owner
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_message_id]
              properties:
                p_message_id:
                  $ref: '#/components/schemas/UUID'
      responses:
        '204':
          description: Message deleted
        '403':
          description: Permission denied

  /rest/v1/rpc/rpc__message_react:
    post:
      tags: [Messages]
      summary: Add reaction to message
      description: |
        Adds emoji reaction to a message.
        
        **Permissions:** Conversation member with write access
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_message_id, p_reaction]
              properties:
                p_message_id:
                  $ref: '#/components/schemas/UUID'
                p_reaction:
                  type: string
                  example: "üëç"
      responses:
        '204':
          description: Reaction added

  /rest/v1/rpc/rpc__message_unreact:
    post:
      tags: [Messages]
      summary: Remove reaction from message
      description: |
        Removes user's reaction from a message.
        
        **Permissions:** User who reacted
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_message_id, p_reaction]
              properties:
                p_message_id:
                  $ref: '#/components/schemas/UUID'
                p_reaction:
                  type: string
                  example: "üëç"
      responses:
        '204':
          description: Reaction removed

  # ======================================================
  # TODO LISTS
  # ======================================================
  /rest/v1/rpc/rpc__todo_list_create:
    post:
      tags: [TODO Lists]
      summary: Create TODO list
      description: |
        Creates a new TODO list in a project.
        
        **Permissions:** Project member
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id]
              properties:
                p_project_id:
                  $ref: '#/components/schemas/UUID'
                p_title:
                  type: string
                  default: "Untitled List"
                  example: "Sprint Tasks"
      responses:
        '200':
          description: TODO list created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    $ref: '#/components/schemas/UUID'
                  project_id:
                    $ref: '#/components/schemas/UUID'
                  title:
                    type: string
                  archived:
                    type: boolean
                  created_by:
                    $ref: '#/components/schemas/UUID'
                  created_at:
                    $ref: '#/components/schemas/Timestamp'

  /rest/v1/rpc/rpc__todo_list_update:
    post:
      tags: [TODO Lists]
      summary: Update TODO list
      description: |
        Updates title or archived status of a TODO list.
        
        **Permissions:** Project member
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_list_id]
              properties:
                p_list_id:
                  $ref: '#/components/schemas/UUID'
                p_title:
                  type: string
                  nullable: true
                p_archived:
                  type: boolean
                  nullable: true
      responses:
        '200':
          description: TODO list updated
          content:
            application/json:
              schema:
                type: object

  /rest/v1/rpc/rpc__todo_list_delete:
    post:
      tags: [TODO Lists]
      summary: Delete TODO list (soft delete)
      description: |
        Soft deletes a TODO list and all its items.
        
        **Permissions:** Project owner or admin
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_list_id]
              properties:
                p_list_id:
                  $ref: '#/components/schemas/UUID'
      responses:
        '204':
          description: TODO list deleted

  # ======================================================
  # TODO ITEMS
  # ======================================================
  /rest/v1/rpc/rpc__todo_item_create:
    post:
      tags: [TODO Items]
      summary: Create TODO item
      description: |
        Creates a new TODO item in a list.
        
        **Permissions:** Project member
        
        **Priority values:** low, medium, high
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_list_id, p_title]
              properties:
                p_list_id:
                  $ref: '#/components/schemas/UUID'
                p_title:
                  type: string
                  example: "Fix login bug"
                p_priority:
                  type: string
                  enum: [low, medium, high]
                  nullable: true
                p_due_date:
                  $ref: '#/components/schemas/Date'
                  nullable: true
                p_assigned_to:
                  $ref: '#/components/schemas/UUID'
                  nullable: true
                  description: Must be a project member
      responses:
        '200':
          description: TODO item created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    $ref: '#/components/schemas/UUID'
                  list_id:
                    $ref: '#/components/schemas/UUID'
                  title:
                    type: string
                  completed:
                    type: boolean
                  priority:
                    type: string
                  due_date:
                    $ref: '#/components/schemas/Date'
                  assigned_to:
                    $ref: '#/components/schemas/UUID'
                  completed_at:
                    $ref: '#/components/schemas/Timestamp'
                    nullable: true
                  created_by:
                    $ref: '#/components/schemas/UUID'
                  created_at:
                    $ref: '#/components/schemas/Timestamp'

  /rest/v1/rpc/rpc__todo_item_update:
    post:
      tags: [TODO Items]
      summary: Update TODO item
      description: |
        Updates TODO item properties.
        
        **Permissions:** Project member
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_item_id]
              properties:
                p_item_id:
                  $ref: '#/components/schemas/UUID'
                p_title:
                  type: string
                  nullable: true
                p_priority:
                  type: string
                  enum: [low, medium, high, ""]
                  nullable: true
                  description: Empty string clears priority
                p_due_date:
                  $ref: '#/components/schemas/Date'
                  nullable: true
                p_assigned_to:
                  $ref: '#/components/schemas/UUID'
                  nullable: true
      responses:
        '200':
          description: TODO item updated
          content:
            application/json:
              schema:
                type: object

  /rest/v1/rpc/rpc__todo_item_toggle_complete:
    post:
      tags: [TODO Items]
      summary: Toggle TODO item completion
      description: |
        Toggles completed status. Auto-sets/clears completed_at.
        
        **Permissions:** Project member
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_item_id]
              properties:
                p_item_id:
                  $ref: '#/components/schemas/UUID'
      responses:
        '200':
          description: TODO item toggled
          content:
            application/json:
              schema:
                type: object
                properties:
                  completed:
                    type: boolean
                  completed_at:
                    $ref: '#/components/schemas/Timestamp'
                    nullable: true

  /rest/v1/rpc/rpc__todo_item_delete:
    post:
      tags: [TODO Items]
      summary: Delete TODO item (soft delete)
      description: |
        Soft deletes a TODO item.
        
        **Permissions:** Project member
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_item_id]
              properties:
                p_item_id:
                  $ref: '#/components/schemas/UUID'
      responses:
        '204':
          description: TODO item deleted

  # ======================================================
  # USERS (Profile & Themes)
  # ======================================================
  /rest/v1/rpc/rpc__user_get_profile:
    post:
      tags: [Auth]
      summary: Get current user profile
      description: |
        Returns the complete profile of the authenticated user.
        Includes color theme (chat colors) and UI mode (light/dark/system).
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    $ref: '#/components/schemas/UUID'
                  name:
                    type: string
                  email:
                    type: string
                  phone:
                    type: string
                    nullable: true
                  avatar:
                    type: string
                    nullable: true
                  color_theme:
                    type: string
                    enum: [blue, purple, green, red, orange, pink, teal, indigo]
                    nullable: true
                    description: Chat color scheme
                  ui_mode:
                    type: string
                    enum: [light, dark, system]
                    nullable: true
                    description: UI theme (light/dark/system)
                  status:
                    type: string
                  created_at:
                    $ref: '#/components/schemas/Timestamp'
                  updated_at:
                    $ref: '#/components/schemas/Timestamp'

  /rest/v1/rpc/rpc__user_update_profile:
    post:
      tags: [Auth]
      summary: Update user profile
      description: |
        Updates name, phone, or avatar of authenticated user.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                p_name:
                  type: string
                  nullable: true
                p_phone:
                  type: string
                  nullable: true
                p_avatar:
                  type: string
                  nullable: true
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    $ref: '#/components/schemas/UUID'
                  name:
                    type: string
                  email:
                    type: string
                  phone:
                    type: string
                    nullable: true
                  avatar:
                    type: string
                    nullable: true
                  color_theme:
                    type: string
                    nullable: true
                  ui_mode:
                    type: string
                    nullable: true
                  status:
                    type: string
                  updated_at:
                    $ref: '#/components/schemas/Timestamp'

  /rest/v1/rpc/rpc__user_update_color_theme:
    post:
      tags: [Auth]
      summary: Update chat color theme
      description: |
        Updates the color theme preference for the authenticated user.
        This controls the color scheme of the chat interface.
        
        **Available colors:**
        - `blue` - Default/Primary
        - `purple` - Royal
        - `green` - Nature
        - `red` - Alert
        - `orange` - Energy
        - `pink` - Soft
        - `teal` - Professional
        - `indigo` - Deep
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_color_theme]
              properties:
                p_color_theme:
                  type: string
                  enum: [blue, purple, green, red, orange, pink, teal, indigo]
                  example: "purple"
                  description: Chat color scheme
      responses:
        '200':
          description: Color theme updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    $ref: '#/components/schemas/UUID'
                  name:
                    type: string
                  email:
                    type: string
                  avatar:
                    type: string
                  color_theme:
                    type: string
                  ui_mode:
                    type: string
                  status:
                    type: string
                  updated_at:
                    $ref: '#/components/schemas/Timestamp'
        '400':
          description: Invalid color theme

  /rest/v1/rpc/rpc__user_update_ui_mode:
    post:
      tags: [Auth]
      summary: Update UI mode (light/dark/system)
      description: |
        Updates the UI mode preference for the authenticated user.
        This controls whether the interface is light or dark.
        
        **UI Modes:**
        - `light` - Force light mode
        - `dark` - Force dark mode
        - `system` - Follow OS preference
        - `null` - Default (treated as system)
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_ui_mode]
              properties:
                p_ui_mode:
                  type: string
                  enum: [light, dark, system]
                  example: "dark"
                  description: UI theme mode
      responses:
        '200':
          description: UI mode updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    $ref: '#/components/schemas/UUID'
                  name:
                    type: string
                  email:
                    type: string
                  avatar:
                    type: string
                  color_theme:
                    type: string
                  ui_mode:
                    type: string
                  status:
                    type: string
                  updated_at:
                    $ref: '#/components/schemas/Timestamp'
        '400':
          description: Invalid UI mode

  # ======================================================
  # FOLLOW-UPS
  # ======================================================
  /rest/v1/rpc/rpc__follow_up_create:
    post:
      tags: [Follow-ups]
      summary: Create follow-up from message
      description: |
        Creates a follow-up task linked to a message.
        
        **Permissions:** Project member
        
        **Status:** pending (default), in_progress, completed, cancelled
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_message_id]
              properties:
                p_message_id:
                  $ref: '#/components/schemas/UUID'
                p_note:
                  type: string
                  nullable: true
                  example: "Need to follow up on this decision"
                p_due_at:
                  $ref: '#/components/schemas/Timestamp'
                  nullable: true
      responses:
        '200':
          description: Follow-up created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    $ref: '#/components/schemas/UUID'
                  project_id:
                    $ref: '#/components/schemas/UUID'
                  message_id:
                    $ref: '#/components/schemas/UUID'
                  owner_id:
                    $ref: '#/components/schemas/UUID'
                  status:
                    type: string
                  note:
                    type: string
                  due_at:
                    $ref: '#/components/schemas/Timestamp'
                  created_at:
                    $ref: '#/components/schemas/Timestamp'

  /rest/v1/rpc/rpc__follow_up_update:
    post:
      tags: [Follow-ups]
      summary: Update follow-up
      description: |
        Updates follow-up status, note, or due date.
        
        **Permissions:** Project member
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_follow_up_id]
              properties:
                p_follow_up_id:
                  $ref: '#/components/schemas/UUID'
                p_status:
                  type: string
                  enum: [pending, in_progress, completed, cancelled]
                  nullable: true
                p_note:
                  type: string
                  nullable: true
                p_due_at:
                  $ref: '#/components/schemas/Timestamp'
                  nullable: true
      responses:
        '200':
          description: Follow-up updated
          content:
            application/json:
              schema:
                type: object

  /rest/v1/rpc/rpc__follow_up_delete:
    post:
      tags: [Follow-ups]
      summary: Delete follow-up (soft delete)
      description: |
        Soft deletes a follow-up.
        
        **Permissions:** Follow-up owner OR project owner/admin
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_follow_up_id]
              properties:
                p_follow_up_id:
                  $ref: '#/components/schemas/UUID'
      responses:
        '204':
          description: Follow-up deleted

  # ======================================================
  # CONVERSATION MEMBERS
  # ======================================================
  /rest/v1/rpc/rpc__conversation_member_add:
    post:
      tags: [Conversations]
      summary: Add member to conversation
      description: |
        Adds a user to a conversation.
        Creates: conversation_member, conversation_role (member), conversation_read.
        
        **Permissions:** Conversation owner or admin
        
        **Note:** User must be a project member first
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_conversation_id, p_user_id]
              properties:
                p_conversation_id:
                  $ref: '#/components/schemas/UUID'
                p_user_id:
                  $ref: '#/components/schemas/UUID'
                  description: Must be a project member
      responses:
        '200':
          description: Member added
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversation_id:
                    $ref: '#/components/schemas/UUID'
                  user_id:
                    $ref: '#/components/schemas/UUID'
                  role:
                    type: string
                    example: member
        '400':
          description: User not a project member or already in conversation
        '403':
          description: Permission denied

  /rest/v1/rpc/rpc__conversation_member_remove:
    post:
      tags: [Conversations]
      summary: Remove member from conversation
      description: |
        Removes a user from a conversation.
        Deletes: conversation_reads, conversation_roles, conversation_members.
        
        **Permissions:** 
        - Conversation owner (can remove anyone)
        - Self-remove (any member can leave)
        
        **Protection:** Cannot remove owner (unless self-remove)
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_conversation_id, p_user_id]
              properties:
                p_conversation_id:
                  $ref: '#/components/schemas/UUID'
                p_user_id:
                  $ref: '#/components/schemas/UUID'
      responses:
        '204':
          description: Member removed
        '403':
          description: Permission denied
        '404':
          description: User not a conversation member

  # ======================================================
  # NOTIFICATIONS
  # ======================================================
  /rest/v1/rpc/rpc__notification_list_for_user:
    post:
      tags: [Notifications]
      summary: List notifications for user
      description: |
        Returns notifications for authenticated user.
        
        **Returns:**
        - `unread`: up to 50 unread notifications
        - `all`: up to 100 total notifications (newest first)
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: Notifications
          content:
            application/json:
              schema:
                type: object
                properties:
                  unread:
                    type: array
                    items:
                      type: object
                  all:
                    type: array
                    items:
                      type: object

  /rest/v1/rpc/rpc__notification_mark_read:
    post:
      tags: [Notifications]
      summary: Mark notification as read
      description: |
        Marks a single notification as read.
        
        **Permissions:** Notification must belong to authenticated user
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_notification_id]
              properties:
                p_notification_id:
                  $ref: '#/components/schemas/UUID'
      responses:
        '204':
          description: Notification marked as read
        '404':
          description: Notification not found or doesn't belong to user

  /rest/v1/rpc/rpc__notification_mark_all_read:
    post:
      tags: [Notifications]
      summary: Mark all notifications as read
      description: |
        Marks all unread notifications of authenticated user as read.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '204':
          description: All notifications marked as read

  # ======================================================
  # DIRECT TABLE ACCESS (RLS-protected)
  # ======================================================
  /rest/v1/conversations:
    get:
      tags: [Direct Access]
      summary: Query conversations table
      description: |
        Direct access to conversations table.
        RLS enforces user can only see their conversations.
        
        **Note:** Prefer using RPC endpoints.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      parameters:
        - in: query
          name: select
          schema:
            type: string
          example: "*"
        - in: query
          name: project_id
          schema:
            $ref: '#/components/schemas/UUID'
        - in: query
          name: deleted_at
          schema:
            type: string
          example: "is.null"
      responses:
        '200':
          description: Conversations list

  /rest/v1/messages:
    get:
      tags: [Direct Access]
      summary: Query messages table
      description: |
        Direct access to messages table.
        RLS enforces conversation membership.
        
        **Note:** Prefer using RPC endpoints.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      parameters:
        - in: query
          name: select
          schema:
            type: string
          example: "*"
        - in: query
          name: conversation_id
          required: true
          schema:
            $ref: '#/components/schemas/UUID'
        - in: query
          name: order
          schema:
            type: string
          example: "created_at.desc"
        - in: query
          name: limit
          schema:
            type: integer
          example: 50
      responses:
        '200':
          description: Messages list

  /rest/v1/rpc/rpc__project_member_list:
    post:
      tags: [Project Members]
      summary: List members of a project
      description: |
        Returns all members of a project.

        Includes:
        - User basic profile
        - Role inside project
        - Joined date

        **Permissions:** Project member only
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id]
              properties:
                p_project_id:
                  $ref: '#/components/schemas/UUID'
      responses:
        '200':
          description: Project members list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    user_id:
                      $ref: '#/components/schemas/UUID'
                    name:
                      type: string
                    email:
                      type: string
                    avatar:
                      type: string
                      nullable: true
                    role:
                      type: string
                      enum: [owner, admin, member]
                    joined_at:
                      $ref: '#/components/schemas/Timestamp'
        '403':
          description: Permission denied

  /rest/v1/rpc/rpc__project_member_search:
    post:
      tags: [Project Members]
      summary: Search members of a project
      description: |
        Searches project members by name or email.

        Case-insensitive search.
        Useful for:
        - Autocomplete
        - Assigning tasks
        - Adding members to conversations

        **Permissions:** Project member only
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id, p_query]
              properties:
                p_project_id:
                  $ref: '#/components/schemas/UUID'
                p_query:
                  type: string
                  example: "jo"
                  description: Search string (name or email)
      responses:
        '200':
          description: Matching project members
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    user_id:
                      $ref: '#/components/schemas/UUID'
                    name:
                      type: string
                    email:
                      type: string
                    avatar:
                      type: string
                      nullable: true
                    role:
                      type: string
                      enum: [owner, admin, member]
        '403':
          description: Permission denied

  /rest/v1/todo_lists:
    get:
      tags: [Direct Access]
      summary: Query TODO lists table
      description: |
        Direct access to todo_lists table.
        RLS enforces project membership.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      parameters:
        - in: query
          name: select
          schema:
            type: string
          example: "*"
        - in: query
          name: project_id
          required: true
          schema:
            $ref: '#/components/schemas/UUID'
        - in: query
          name: deleted_at
          schema:
            type: string
          example: "is.null"
      responses:
        '200':
          description: TODO lists

  /rest/v1/todo_items:
    get:
      tags: [Direct Access]
      summary: Query TODO items table
      description: |
        Direct access to todo_items table.
        RLS enforces project membership via list_id.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      parameters:
        - in: query
          name: select
          schema:
            type: string
          example: "*"
        - in: query
          name: list_id
          required: true
          schema:
            $ref: '#/components/schemas/UUID'
        - in: query
          name: completed
          schema:
            type: string
          example: "eq.false"
        - in: query
          name: order
          schema:
            type: string
          example: "priority.desc,created_at.asc"
      responses:
        '200':
          description: TODO items

  /rest/v1/follow_ups:
    get:
      tags: [Direct Access]
      summary: Query follow-ups table
      description: |
        Direct access to follow_ups table.
        RLS enforces project membership.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      parameters:
        - in: query
          name: select
          schema:
            type: string
          example: "*"
        - in: query
          name: project_id
          schema:
            $ref: '#/components/schemas/UUID'
        - in: query
          name: status
          schema:
            type: string
          example: "eq.pending"
      responses:
        '200':
          description: Follow-ups list
