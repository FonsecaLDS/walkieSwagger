openapi: 3.0.3

info:
  title: Walkie REST API
  description: |
    Official REST API documentation for Walker Backend.

    • Authentication handled via Supabase Auth
    • Business logic implemented via PostgreSQL RPCs
    • Row Level Security (RLS) enforced at database level
    • Frontend never sends user_id (resolved from auth.uid())
  version: 1.1.0

servers:
  - url: https://ftafbdjzritdvsibpqtp.supabase.co

tags:
  - name: Auth
    description: Authentication & user identity (Supabase)
  - name: Projects
    description: Project management
  - name: Conversations
    description: Conversations & memberships
  - name: Messages
    description: Messages & read state

# ==========================
# SECURITY
# ==========================
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: apikey

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

# ==========================
# PATHS
# ==========================
paths:

  # ======================================================
  # AUTH — SIGN UP (EMAIL / PASSWORD)
  # ======================================================
  /auth/v1/token:
    post:
      tags: [Auth]
      summary: Login or Sign Up with email and password
      description: |
        Supabase Auth endpoint.

        • grant_type=password → login
        • grant_type=signup → create account
      security:
        - ApiKeyAuth: []
      parameters:
        - in: query
          name: grant_type
          required: true
          schema:
            type: string
            enum: [password, signup]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  example: alice@walker.dev
                password:
                  type: string
                  example: strongpassword123
      responses:
        '200':
          description: Authenticated successfully
        '400':
          description: Invalid credentials

  # ======================================================
  # AUTH — OAUTH (GOOGLE / APPLE)
  # ======================================================
  /auth/v1/authorize:
    get:
      tags: [Auth]
      summary: OAuth login (Google / Apple)
      description: |
        Redirect-based OAuth flow.

        Used for:
        • Google Sign In
        • Apple Sign In
      parameters:
        - in: query
          name: provider
          required: true
          schema:
            type: string
            enum: [google, apple]
        - in: query
          name: redirect_to
          required: false
          schema:
            type: string
            example: https://app.walker.dev/auth/callback
      responses:
        '302':
          description: Redirect to OAuth provider

  # ======================================================
  # PROJECTS — CREATE
  # ======================================================
  /rest/v1/rpc/rpc__project_create:
    post:
      tags: [Projects]
      summary: Create project
      description: |
        Creates a new project.
        Authenticated user becomes owner.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_name, p_description]
              properties:
                p_name:
                  type: string
                p_description:
                  type: string
      responses:
        '200':
          description: Project ID
          content:
            application/json:
              schema:
                type: string
                format: uuid

  # ======================================================
  # PROJECTS — LIST
  # ======================================================
  /rest/v1/rpc/rpc__project_list_for_user:
    post:
      tags: [Projects]
      summary: List projects for authenticated user
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: Projects list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    project_id:
                      type: string
                      format: uuid
                    name:
                      type: string
                    archived:
                      type: boolean
                    role:
                      type: string
                      example: owner
                    unread_messages_count:
                      type: integer
                    last_activity_at:
                      type: string
                      format: date-time

  # ======================================================
  # PROJECTS — ARCHIVE
  # ======================================================
  /rest/v1/rpc/rpc__project_archive:
    post:
      tags: [Projects]
      summary: Archive or unarchive project
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id, p_archived]
              properties:
                p_project_id:
                  type: string
                  format: uuid
                p_archived:
                  type: boolean
      responses:
        '200':
          description: Project updated

  # ======================================================
  # CONVERSATIONS — CREATE (RPC)
  # ======================================================
  /rest/v1/rpc/rpc__conversation_create:
    post:
      tags: [Conversations]
      summary: Create conversation
      description: |
        Creates a new conversation inside a project.
        User becomes conversation owner.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id, p_title]
              properties:
                p_project_id:
                  type: string
                  format: uuid
                p_title:
                  type: string
      responses:
        '200':
          description: Conversation ID
          content:
            application/json:
              schema:
                type: string
                format: uuid

  # ======================================================
  # CONVERSATIONS — LIST (RLS)
  # ======================================================
  /rest/v1/conversations:
    get:
      tags: [Conversations]
      summary: List conversations
      description: |
        Returns conversations visible to user.
        Enforced via RLS.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: Conversations list

  # ======================================================
  # MESSAGES — LIST
  # ======================================================
  /rest/v1/messages:
    get:
      tags: [Messages]
      summary: List messages
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      parameters:
        - in: query
          name: conversation_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Messages list

    post:
      tags: [Messages]
      summary: Send message
      description: |
        Inserts message into conversation.
        sender_id resolved from auth.uid().
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [conversation_id, content]
              properties:
                conversation_id:
                  type: string
                  format: uuid
                content:
                  type: string
      responses:
        '201':
          description: Message created

  # ======================================================
  # READ STATUS
  # ======================================================
  /rest/v1/conversation_reads:
    post:
      tags: [Messages]
      summary: Update read state
      description: |
        Updates last_read_message_id for authenticated user.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [conversation_id, last_read_message_id]
              properties:
                conversation_id:
                  type: string
                  format: uuid
                last_read_message_id:
                  type: string
                  format: uuid
      responses:
        '204':
          description: Read state updated