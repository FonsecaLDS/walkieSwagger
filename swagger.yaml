openapi: 3.0.3

info:
  title: Walkie REST API
  description: |
    Official REST API documentation for Walker Backend.
    All business logic lives in PostgreSQL RPCs (Supabase).
    Authentication is handled via Supabase Auth.
    Row Level Security (RLS) is enforced at the database level.
  version: 1.1.0

servers:
  - url: https://ftafbdjzritdvsibpqtp.supabase.co

tags:
  - name: Auth
    description: Authentication (Supabase)
  - name: Projects
    description: Project management
  - name: Conversations
    description: Conversations and memberships
  - name: Messages
    description: Messages and reads

# ==========================
# SECURITY DEFINITIONS
# ==========================
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: apikey

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

# ==========================
# PATHS
# ==========================
paths:

  # ==========================
  # AUTH â€” EMAIL / PASSWORD
  # ==========================
  /auth/v1/token:
    post:
      tags: [Auth]
      summary: Login with email and password
      security:
        - ApiKeyAuth: []
      parameters:
        - in: query
          name: grant_type
          required: true
          schema:
            type: string
            enum: [password]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: Authenticated

  # ==========================
  # PROJECTS
  # ==========================
  /rest/v1/rpc/rpc__project_create:
    post:
      tags: [Projects]
      summary: Create a project
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_name, p_description]
              properties:
                p_name:
                  type: string
                p_description:
                  type: string
      responses:
        '200':
          description: Project ID
          content:
            application/json:
              schema:
                type: string
                format: uuid

  /rest/v1/rpc/rpc__project_list_for_user:
    post:
      tags: [Projects]
      summary: List projects for authenticated user
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: Projects list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    project_id:
                      type: string
                      format: uuid
                    name:
                      type: string
                    archived:
                      type: boolean
                    role:
                      type: string
                      example: owner
                    unread_messages_count:
                      type: integer
                    last_activity_at:
                      type: string
                      format: date-time

  /rest/v1/rpc/rpc__project_archive:
    post:
      tags: [Projects]
      summary: Archive or unarchive project
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id, p_archived]
              properties:
                p_project_id:
                  type: string
                  format: uuid
                p_archived:
                  type: boolean
      responses:
        '200':
          description: Updated project

  # ==========================
  # CONVERSATIONS
  # ==========================
  /rest/v1/conversations:
    get:
      tags: [Conversations]
      summary: List conversations visible to user
      description: |
        Uses RLS. Returns conversations where user is a member.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: Conversation list

  # ==========================
  # MESSAGES
  # ==========================
  /rest/v1/messages:
    get:
      tags: [Messages]
      summary: List messages
      description: |
        Returns messages user can read.
        Requires conversation membership (RLS).
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      parameters:
        - in: query
          name: conversation_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Messages list

    post:
      tags: [Messages]
      summary: Send a message
      description: |
        Inserts a message into a conversation.
        sender_id is resolved from auth.uid().
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [conversation_id, content]
              properties:
                conversation_id:
                  type: string
                  format: uuid
                content:
                  type: string
      responses:
        '201':
          description: Message created

  # ==========================
  # READ STATUS
  # ==========================
  /rest/v1/conversation_reads:
    post:
      tags: [Messages]
      summary: Update read state
      description: |
        Updates last_read_message_id for authenticated user.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [conversation_id, last_read_message_id]
              properties:
                conversation_id:
                  type: string
                  format: uuid
                last_read_message_id:
                  type: string
                  format: uuid
      responses:
        '204':
          description: Read state updated
