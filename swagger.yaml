openapi: 3.0.3

info:
  title: Walkie REST API
  version: 2.0
  description: |
    Official REST API documentation for Walkie Backend.

servers:
  - url: https://ftafbdjzritdvsibpqtp.supabase.co

tags:
  - name: Auth
    description: Authentication and user lifecycle (Supabase Auth)
  - name: Projects
    description: Project domain
  - name: Conversations
    description: Conversations and memberships
  - name: Messages
    description: Messages and read state

# ==========================
# SECURITY
# ==========================
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: apikey

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

# ==========================
# PATHS
# ==========================
paths:

  # =====================================================
  # AUTH — SIGN UP
  # =====================================================
  /auth/v1/signup:
    post:
      tags: [Auth]
      summary: Create user (Sign up)
      description: |
        Creates a new user via Supabase Auth.

        Post-signup behavior:
        - public.users row is created automatically via trigger
        - User is authenticated
        - All RLS policies apply immediately

        This endpoint is NOT part of the domain layer.
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  example: alice@walker.dev
                password:
                  type: string
                  example: strongPassword123
                data:
                  type: object
                  description: Optional metadata
                  example:
                    name: Alice
      responses:
        '200':
          description: User created and authenticated
        '400':
          description: Invalid input
        '409':
          description: User already exists

  # =====================================================
  # AUTH — LOGIN
  # =====================================================
  /auth/v1/token:
    post:
      tags: [Auth]
      summary: Login with email and password
      security:
        - ApiKeyAuth: []
      parameters:
        - in: query
          name: grant_type
          required: true
          schema:
            type: string
            enum: [password]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: Authenticated successfully
        '401':
          description: Invalid credentials

  # =====================================================
  # PROJECTS — CREATE
  # =====================================================
  /rest/v1/rpc/rpc__project_create:
    post:
      tags: [Projects]
      summary: Create project
      description: |
        Creates a project and assigns the authenticated user as owner.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_name, p_description]
              properties:
                p_name:
                  type: string
                p_description:
                  type: string
      responses:
        '200':
          description: Project ID
          content:
            application/json:
              schema:
                type: string
                format: uuid

  # =====================================================
  # PROJECTS — LIST
  # =====================================================
  /rest/v1/rpc/rpc__project_list_for_user:
    post:
      tags: [Projects]
      summary: List user projects
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: Projects list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    project_id:
                      type: string
                      format: uuid
                    name:
                      type: string
                    archived:
                      type: boolean
                    role:
                      type: string
                    unread_messages_count:
                      type: integer
                    last_activity_at:
                      type: string
                      format: date-time

  # =====================================================
  # PROJECTS — ARCHIVE
  # =====================================================
  /rest/v1/rpc/rpc__project_archive:
    post:
      tags: [Projects]
      summary: Archive / unarchive project
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id, p_archived]
              properties:
                p_project_id:
                  type: string
                  format: uuid
                p_archived:
                  type: boolean
      responses:
        '200':
          description: Project updated

  # =====================================================
  # CONVERSATIONS — CREATE (RPC 029)
  # =====================================================
  /rest/v1/rpc/rpc__conversation_create:
    post:
      tags: [Conversations]
      summary: Create conversation
      description: |
        Creates a new conversation inside a project.
        Creator becomes conversation owner automatically.
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [p_project_id, p_title]
              properties:
                p_project_id:
                  type: string
                  format: uuid
                p_title:
                  type: string
      responses:
        '200':
          description: Conversation ID
          content:
            application/json:
              schema:
                type: string
                format: uuid

  # =====================================================
  # CONVERSATIONS — LIST (RLS)
  # =====================================================
  /rest/v1/conversations:
    get:
      tags: [Conversations]
      summary: List conversations
      description: |
        Returns conversations where the authenticated user is a member.
        Uses RLS directly (no RPC).
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: Conversation list

  # =====================================================
  # MESSAGES — LIST
  # =====================================================
  /rest/v1/messages:
    get:
      tags: [Messages]
      summary: List messages
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      parameters:
        - in: query
          name: conversation_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Messages list

    post:
      tags: [Messages]
      summary: Send message
      description: |
        Inserts a message into a conversation.
        sender_id is resolved from auth.uid().
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [conversation_id, content]
              properties:
                conversation_id:
                  type: string
                  format: uuid
                content:
                  type: string
      responses:
        '201':
          description: Message created

  # =====================================================
  # READ STATUS
  # =====================================================
  /rest/v1/conversation_reads:
    post:
      tags: [Messages]
      summary: Update read state
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [conversation_id, last_read_message_id]
              properties:
                conversation_id:
                  type: string
                  format: uuid
                last_read_message_id:
                  type: string
                  format: uuid
      responses:
        '204':
          description: Read state updated